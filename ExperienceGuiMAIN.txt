-- experienceguimain | Version 3.0.3 | MACLIB FIXED VERSION

local function StartExperienceGui()
    local HttpService = game:GetService("HttpService")
    local Players = game:GetService("Players")
    local LocalPlayer = Players.LocalPlayer

    -- Destroy leftover maintenance GUI
    for _, gui in ipairs(game.CoreGui:GetChildren()) do
        if gui.Name:find("ExperienceGui - Maintenance") then
            gui:Destroy()
        end
    end

    -- Load MacLib
    local MacLib = loadstring(game:HttpGet("https://github.com/biggaboy212/Maclib/releases/latest/download/maclib.txt"))()

    -- Create Window with rounded corners style
    local Window = MacLib:Window({
        Title = "ExperienceGui",
        Subtitle = "Made by CoolDown | MacLib",
        Size = UDim2.fromOffset(900, 680),
        DragStyle = 1,
        ShowUserInfo = true,
        Keybind = Enum.KeyCode.RightControl,
        AcrylicBlur = true,
        Rounding = 8, -- Added for rounded corners
    })

    -- Set theme with accent color
    Window.Settings.Theme = {
        Accent = Color3.fromRGB(85, 160, 255),
        Background = Color3.fromRGB(12, 15, 22),
        Secondary = Color3.fromRGB(18, 22, 32),
        Text = Color3.fromRGB(240, 240, 240),
        Muted = Color3.fromRGB(160, 160, 160),
    }

    Window:SetScale(1.07)
    Window:SetAcrylicBlurState(true)

    -- Apply additional rounding to window elements
    if Window.ApplyRounding then
        Window:ApplyRounding(12) -- More rounded corners
    end

    ------------------------
    -- GLOBAL VARIABLES
    ------------------------
    local keyPassed = false
    local VALID_KEYS = {"CoolDownExperience"}
    local authTabGroup = nil
    local MainTabGroup, ScriptTabGroup, NewsTabGroup = nil, nil, nil

    ------------------------
    -- AUTHENTICATION FUNCTION
    ------------------------
    local function showAuthUI()
        -- Create auth tab group
        authTabGroup = Window:TabGroup()
        local authTab = authTabGroup:Tab({ 
            Name = "üîí AUTHENTICATION", 
            Image = "rbxassetid://10734950309" 
        })
        local authSection = authTab:Section({ Side = "Left" })
        
        authSection:Header({ Name = "ExperienceGui Access" })
        authSection:Label({ Text = "Enter Password" })
        authSection:Label({ Text = "Password required to continue" })
        
        local keyInput = ""
        local keyInputElement = authSection:Input({
            Name = "Password",
            Placeholder = "Enter password here",
            Callback = function(input)
                keyInput = input
            end
        })
        
        authSection:Button({
            Name = "üîì Authenticate",
            Callback = function()
                -- Check if key is valid
                local isValid = false
                for _, validKey in ipairs(VALID_KEYS) do
                    if keyInput == validKey then
                        isValid = true
                        break
                    end
                end
                
                if isValid then
                    keyPassed = true
                    Window:Notify({
                        Title = "‚úÖ Access Granted",
                        Description = "Welcome to ExperienceGui!",
                        Lifetime = 3
                    })
                    -- Remove auth tab
                    authTabGroup:Remove()
                    authTabGroup = nil
                    -- Create main UI
                    createMainUI()
                else
                    Window:Notify({
                        Title = "‚ùå Invalid Password",
                        Description = "Please check your password and try again",
                        Lifetime = 3
                    })
                    keyInputElement:Set("")
                    keyInput = ""
                end
            end
        })
        
        authTab:Select() -- Select the auth tab by default
    end

    ------------------------
    -- MAIN UI CREATION FUNCTION
    ------------------------
    local function createMainUI()
        print("Creating main UI...")
        
        ------------------------
        -- CREATE TAB GROUPS
        ------------------------
        MainTabGroup = Window:TabGroup()
        ScriptTabGroup = Window:TabGroup()
        NewsTabGroup = Window:TabGroup()
        
        -- Create tabs
        local HomeTab = MainTabGroup:Tab({ Name = "Home", Image = "rbxassetid://18821914323" })
        local NeedsTab = MainTabGroup:Tab({ Name = "Basic Needs", Image = "rbxassetid://10734950309" })
        local ScriptsTab = MainTabGroup:Tab({ Name = "Script Library", Image = "rbxassetid://10734950309" })
        local ExecTab = ScriptTabGroup:Tab({ Name = "Script Executor", Image = "rbxassetid://10734950309" })
        local ScriptBloxTab = ScriptTabGroup:Tab({ Name = "ScriptBlox", Image = "rbxassetid://10734950309" })
        local FavoritesTab = ScriptTabGroup:Tab({ Name = "Favorites", Image = "rbxassetid://10734950309" })
        local AnnTab = NewsTabGroup:Tab({ Name = "News", Image = "rbxassetid://10734950309" })
        
        ------------------------
        -- HOME TAB
        ------------------------
        local HomeSection = HomeTab:Section({ Side = "Left" })
        HomeSection:Header({ Name = "Welcome to ExperienceGui" })
        HomeSection:Label({ Text = "Made by CoolDown" })
        
        -- Get version from config
        local version = "Unknown"
        local ok, result = pcall(function()
            return game:HttpGet("https://raw.githubusercontent.com/ARandomDumDev/ExperienceGui/refs/heads/main/config.json")
        end)
        if ok then
            local decodeOk, decoded = pcall(function()
                return HttpService:JSONDecode(result)
            end)
            if decodeOk and decoded.version then
                version = decoded.version
            end
        end
        
        HomeSection:Label({ Text = "Client: " .. LocalPlayer.Name })
        HomeSection:Label({ Text = "Version " .. version })
        HomeSection:Label({ Text = "‚úÖ Authenticated Successfully" })
        
        ------------------------
        -- BASIC NEEDS TAB
        ------------------------
        local NeedsSection = NeedsTab:Section({ Side = "Left" })
        
        local walkSpeed = 16
        local jumpPower = 50
        
        NeedsSection:Slider({
            Name = "WalkSpeed",
            Default = 16,
            Minimum = 16,
            Maximum = 200,
            Precision = 0,
            Callback = function(Value)
                walkSpeed = Value
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChildWhichIsA("Humanoid") then
                    LocalPlayer.Character:FindFirstChildWhichIsA("Humanoid").WalkSpeed = Value
                end
            end
        })
        
        NeedsSection:Slider({
            Name = "JumpPower",
            Default = 50,
            Minimum = 50,
            Maximum = 300,
            Precision = 5,
            Callback = function(Value)
                jumpPower = Value
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChildWhichIsA("Humanoid") then
                    LocalPlayer.Character:FindFirstChildWhichIsA("Humanoid").JumpPower = Value
                end
            end
        })
        
        NeedsSection:Button({
            Name = "Enable Fly",
            Callback = function()
                loadstring(game:HttpGet("https://raw.githubusercontent.com/XNEOFF/FlyGuiV3/main/FlyGuiV3.txt"))()
            end
        })
        
        ------------------------
        -- SCRIPT EXECUTOR TAB
        ------------------------
        local ExecSection = ExecTab:Section({ Side = "Left" })
        ExecSection:Header({ Name = "Run Custom Code" })
        
        local codeString, urlString = "", ""
        
        local codeInputElement = ExecSection:Input({
            Name = "Lua Code",
            Placeholder = "Type Lua code here...",
            Callback = function(text)
                codeString = text
            end
        })
        
        local urlInputElement = ExecSection:Input({
            Name = "Script URL",
            Placeholder = "Type script URL here...",
            Callback = function(text)
                urlString = text
            end
        })
        
        ExecSection:Button({
            Name = "Execute",
            Callback = function()
                if codeString ~= "" then
                    local ok, err = pcall(function()
                        loadstring(codeString)()
                    end)
                    if not ok then 
                        warn("Failed to execute Lua code:", err)
                        Window:Notify({
                            Title = "Execution Error",
                            Description = tostring(err):sub(1, 100),
                            Lifetime = 5
                        })
                    else
                        Window:Notify({
                            Title = "‚úÖ Success",
                            Description = "Code executed successfully",
                            Lifetime = 3
                        })
                    end
                elseif urlString ~= "" then
                    local ok, err = pcall(function()
                        local scriptText = game:HttpGet(urlString)
                        loadstring(scriptText)()
                    end)
                    if not ok then 
                        warn("Failed to execute URL script:", err)
                        Window:Notify({
                            Title = "Download Error",
                            Description = tostring(err):sub(1, 100),
                            Lifetime = 5
                        })
                    else
                        Window:Notify({
                            Title = "‚úÖ Success",
                            Description = "Script loaded from URL",
                            Lifetime = 3
                        })
                    end
                end
                -- Clear input fields
                codeString = ""
                urlString = ""
                codeInputElement:Set("")
                urlInputElement:Set("")
            end
        })
        
        ------------------------
        -- SCRIPT LIBRARY
        ------------------------
        local ScriptsSection = ScriptsTab:Section({ Side = "Left" })
        
        local function LoadScriptLibrary()
            local success, result = pcall(function()
                return game:HttpGet("https://raw.githubusercontent.com/ARandomDumDev/ExperienceGui/refs/heads/main/Scripts.txt", true)
            end)
            if not success then
                ScriptsSection:Label({ Text = "‚ö†Ô∏è Failed to fetch Scripts.txt" })
                warn("HTTP GET failed:", result)
                return
            end

            local scripts
            local decodeSuccess, decodeResult = pcall(function()
                return HttpService:JSONDecode(result)
            end)
            if not decodeSuccess then
                ScriptsSection:Label({ Text = "‚ö†Ô∏è Failed to decode Scripts.txt" })
                warn("JSON Decode failed:", decodeResult)
                return
            end

            scripts = decodeResult
            if type(scripts) ~= "table" or #scripts == 0 then
                ScriptsSection:Label({ Text = "‚ö†Ô∏è No scripts found" })
                return
            end

            for _, scriptData in ipairs(scripts) do
                ScriptsSection:Button({
                    Name = scriptData.name or "Unnamed Script",
                    Callback = function()
                        if scriptData.url then
                            local ok, err = pcall(function()
                                loadstring(game:HttpGet(scriptData.url, true))()
                            end)
                            if not ok then 
                                warn("Failed to load script:", scriptData.name, err)
                                Window:Notify({
                                    Title = "Script Error",
                                    Description = "Failed to load: " .. (scriptData.name or "script"),
                                    Lifetime = 5
                                })
                            else
                                Window:Notify({
                                    Title = "‚úÖ Script Loaded",
                                    Description = "Successfully loaded: " .. (scriptData.name or "script"),
                                    Lifetime = 3
                                })
                            end
                        elseif scriptData.code then
                            local ok, err = pcall(function()
                                loadstring(scriptData.code)()
                            end)
                            if not ok then 
                                warn("Failed to execute script:", scriptData.name, err)
                                Window:Notify({
                                    Title = "Script Error",
                                    Description = "Failed to execute: " .. (scriptData.name or "script"),
                                    Lifetime = 5
                                })
                            else
                                Window:Notify({
                                    Title = "‚úÖ Script Executed",
                                    Description = "Successfully executed: " .. (scriptData.name or "script"),
                                    Lifetime = 3
                                })
                            end
                        else
                            warn("No url or code found for script:", scriptData.name)
                        end
                    end
                })
            end
        end
        
        -- Load script library after a delay
        task.spawn(function()
            task.wait(1)
            pcall(LoadScriptLibrary)
        end)
        
        ------------------------
        -- SCRIPTBLOX + FAVORITES SYSTEM
        ------------------------
        -- Saved favorites
        local savedScripts = {}
        local savedFile = "ExperienceGui/SavedScripts.json"
        
        local function LoadSavedScriptsFromFile()
            if type(readfile) ~= "function" then return end
            local ok, content = pcall(function() return readfile(savedFile) end)
            if ok and content and content ~= "" then
                local sOk, data = pcall(function() return HttpService:JSONDecode(content) end)
                if sOk and type(data) == "table" then
                    savedScripts = data
                end
            end
        end
        
        local function SaveScriptsToFile()
            if type(writefile) ~= "function" then return end
            local ok, json = pcall(function() return HttpService:JSONEncode(savedScripts) end)
            if ok then pcall(function() writefile(savedFile, json) end) end
        end
        
        local function RefreshFavoritesUI()
            FavoritesTab:ClearSections()
            local FavSection = FavoritesTab:Section({ Side = "Left" })
            FavSection:Header({ Name = "‚≠ê Favorites" })
            
            if #savedScripts == 0 then
                FavSection:Label({ Text = "‚ö†Ô∏è No favorites saved yet" })
                FavSection:Label({ Text = "Save scripts from ScriptBlox or Library!" })
                return
            end
            
            for i, s in ipairs(savedScripts) do
                local title = s.title or ("Saved Script " .. i)
                FavSection:Button({
                    Name = "‚ñ∂ "..title,
                    Callback = function()
                        local ok, err = pcall(function()
                            if s.code and s.code ~= "" then
                                loadstring(s.code)()
                            elseif s.url and s.url ~= "" then
                                local scriptText = game:HttpGet(s.url, true)
                                loadstring(scriptText)()
                            else
                                warn("Favorite has neither code nor url:", title)
                            end
                        end)
                        if not ok then 
                            warn("Failed to run favorite:", title, err)
                            Window:Notify({
                                Title = "Favorite Error",
                                Description = "Failed to run: " .. title,
                                Lifetime = 5
                            })
                        else
                            Window:Notify({
                                Title = "‚úÖ Favorite Loaded",
                                Description = "Successfully loaded: " .. title,
                                Lifetime = 3
                            })
                        end
                    end
                })
                
                FavSection:Button({
                    Name = "üóëÔ∏è Remove",
                    Callback = function()
                        table.remove(savedScripts, i)
                        SaveScriptsToFile()
                        RefreshFavoritesUI()
                        Window:Notify({
                            Title = "‚úÖ Removed",
                            Description = "Removed from favorites: " .. title,
                            Lifetime = 3
                        })
                    end
                })
                
                FavSection:Divider()
            end
        end
        
        local function SaveFavorite(entry)
            entry = entry or {}
            for _, e in ipairs(savedScripts) do
                if entry.url and e.url == entry.url then return end
                if entry.title and e.title == entry.title and (entry.code == e.code) then return end
            end
            table.insert(savedScripts, entry)
            SaveScriptsToFile()
            RefreshFavoritesUI()
        end
        
        local function MeasurePing(timeoutSeconds)
            timeoutSeconds = timeoutSeconds or 5
            local apiProbe = "https://scriptblox.com/api/script/search?limit=1&sort=trending"
            local startTime = os.clock()
            local ok, _ = pcall(function()
                game:HttpGet(apiProbe, true)
            end)
            local elapsed = os.clock() - startTime
            if not ok then return nil end
            return elapsed
        end
        
        local function UrlEncode(s)
            if type(s) ~= "string" then return "" end
            local ok, enc = pcall(function() return HttpService:UrlEncode(s) end)
            if ok and type(enc) == "string" then return enc end
            s = s:gsub("([^%w ])", function(c) return string.format("%%%02X", string.byte(c)) end)
            s = s:gsub(" ", "+")
            return s
        end
        
        local function SearchScriptBlox(query, limit)
            limit = limit or 20
            local q = query or ""
            local encoded = UrlEncode(q)
            local url
            if q == "" then
                url = string.format("https://scriptblox.com/api/script/fetch?max=%d", limit)
            else
                url = string.format("https://scriptblox.com/api/script/search?q=%s&max=%d", encoded, limit)
            end

            local ok, response = pcall(function() return game:HttpGet(url, true) end)
            if not ok then return nil, ("HTTP GET failed: %s"):format(tostring(response)) end
            local decOk, data = pcall(function() return HttpService:JSONDecode(response) end)
            if not decOk then return nil, ("JSON decode failed: %s"):format(tostring(data)) end
            if not data or not data.result or not data.result.scripts then
                return nil, "No scripts in response"
            end
            return data.result.scripts, nil
        end
        
        local function RenderScriptBloxResults(scripts)
            ScriptBloxTab:ClearSections()
            local SBSection = ScriptBloxTab:Section({ Side = "Left" })
            SBSection:Header({ Name = "Search Results" })
            
            if not scripts or #scripts == 0 then
                SBSection:Label({ Text = "‚ö†Ô∏è No scripts found" })
                return
            end
            
            for _, info in ipairs(scripts) do
                local title = info.title or "Unnamed Script"
                local gameName = (info.game and info.game.name) or "Unknown Game"
                local display = ("[%s] %s"):format(gameName, title)

                SBSection:Button({
                    Name = "‚ñ∂ "..display,
                    Callback = function()
                        local executed = false
                        if info.script and type(info.script) == "string" and info.script:match("%S") then
                            local ok, err = pcall(function() loadstring(info.script)() end)
                            if not ok then 
                                warn("Failed to execute inline script:", title, err)
                                Window:Notify({
                                    Title = "Script Error",
                                    Description = "Failed to execute: " .. title,
                                    Lifetime = 5
                                })
                            else
                                executed = true
                            end
                        elseif info.scriptUrl and type(info.scriptUrl) == "string" then
                            local ok, err = pcall(function()
                                local scriptText = game:HttpGet(info.scriptUrl, true)
                                loadstring(scriptText)()
                            end)
                            if not ok then 
                                warn("Failed to fetch/execute script:", title, err)
                                Window:Notify({
                                    Title = "Script Error",
                                    Description = "Failed to load from URL",
                                    Lifetime = 5
                                })
                            else
                                executed = true
                            end
                        end
                        
                        if executed then
                            Window:Notify({
                                Title = "‚úÖ Script Loaded",
                                Description = "Successfully loaded: " .. title,
                                Lifetime = 3
                            })
                        else
                            Window:Notify({
                                Title = "‚ùå Failed to Load",
                                Description = "Unable to execute: " .. title,
                                Lifetime = 5
                            })
                        end
                    end
                })

                SBSection:Button({
                    Name = "‚≠ê Save to Favorites",
                    Callback = function()
                        local entry = {
                            title = title,
                            url = info.scriptUrl or info.url or info.link or nil,
                            code = (info.script and type(info.script) == "string") and info.script or nil,
                            id = info._id or info.script_id or nil,
                            game = (info.game and info.game.name) or nil
                        }
                        SaveFavorite(entry)
                        Window:Notify({
                            Title = "‚úÖ Saved",
                            Description = "Added to favorites: " .. title,
                            Lifetime = 3
                        })
                    end
                })
                
                SBSection:Divider()
            end
        end
        
        -- ScriptBlox UI
        local SBMainSection = ScriptBloxTab:Section({ Side = "Left" })
        SBMainSection:Header({ Name = "ScriptBlox Search" })
        
        local searchQuery = ""
        local searchInputElement = SBMainSection:Input({
            Name = "Search Query",
            Placeholder = "Type keywords to search ScriptBlox...",
            Callback = function(text)
                searchQuery = text or ""
            end
        })
        
        SBMainSection:Button({
            Name = "üîç Search ScriptBlox",
            Callback = function()
                ScriptBloxTab:ClearSections()
                local LoadingSection = ScriptBloxTab:Section({ Side = "Left" })
                LoadingSection:Label({ Text = "Searching ScriptBlox..." })
                
                task.spawn(function()
                    local scripts, err = SearchScriptBlox(searchQuery, 25)
                    if not scripts then
                        ScriptBloxTab:ClearSections()
                        local ErrSection = ScriptBloxTab:Section({ Side = "Left" })
                        ErrSection:Header({ Name = "Search Failed" })
                        ErrSection:Label({ Text = "Error: "..tostring(err) })
                        return
                    end
                    RenderScriptBloxResults(scripts)
                end)
            end
        })
        
        SBMainSection:Button({
            Name = "üìà Load Trending",
            Callback = function()
                ScriptBloxTab:ClearSections()
                local LoadingSection = ScriptBloxTab:Section({ Side = "Left" })
                LoadingSection:Label({ Text = "Loading trending scripts..." })
                
                task.spawn(function()
                    local scripts, err = SearchScriptBlox("", 25)
                    if not scripts then
                        ScriptBloxTab:ClearSections()
                        local ErrSection = ScriptBloxTab:Section({ Side = "Left" })
                        ErrSection:Header({ Name = "Failed to Load" })
                        ErrSection:Label({ Text = "Error: "..tostring(err) })
                        return
                    end
                    RenderScriptBloxResults(scripts)
                end)
            end
        })
        
        -- Initial trending load
        task.spawn(function()
            local scripts, err = SearchScriptBlox("", 20)
            if scripts then
                RenderScriptBloxResults(scripts)
            else
                SBMainSection:Label({ Text = "Note: Use buttons above to search ScriptBlox" })
            end
        end)
        
        -- Load favorites
        LoadSavedScriptsFromFile()
        RefreshFavoritesUI()
        
        ------------------------
        -- NEWS TAB
        ------------------------
        local function LoadAnnouncements()
            AnnTab:ClearSections()
            local NewsSection = AnnTab:Section({ Side = "Left" })
            NewsSection:Header({ Name = "üì∞ News & Updates" })
            
            local success, result = pcall(function()
                return game:HttpGet("https://raw.githubusercontent.com/ARandomDumDev/ExperienceGui/refs/heads/main/announcementsChangelogs.json", true)
            end)
            
            if not success then
                NewsSection:Label({ Text = "‚ö†Ô∏è Failed to fetch announcements" })
                return
            end

            local data
            local decodeSuccess, decodeResult = pcall(function()
                return HttpService:JSONDecode(result)
            end)
            
            if not decodeSuccess then
                NewsSection:Label({ Text = "‚ö†Ô∏è Failed to decode announcements" })
                return
            end

            data = decodeResult
            if data.announcement then
                NewsSection:Label({ Text = "üì¢ Announcement: " .. data.announcement })
                NewsSection:Divider()
            end

            if data.changelog then
                NewsSection:Label({ Text = "üìù Changelog: " .. data.changelog })
            end
        end
        
        LoadAnnouncements()
        task.spawn(function()
            while true do
                task.wait(60)
                LoadAnnouncements()
            end
        end)
        
        ------------------------
        -- AUTORUN
        ------------------------
        task.spawn(function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/VapeVoidware/VW-Add/main/loader.lua", true))()
        end)
        
        ------------------------
        -- SELECT HOME TAB
        ------------------------
        HomeTab:Select()
        
        ------------------------
        -- FINAL NOTIFICATION
        ------------------------
        Window:Notify({
            Title = "‚úÖ ExperienceGui",
            Description = "Successfully loaded with MacLib!",
            Lifetime = 3
        })
        
        print("‚úÖ Main UI created successfully!")
    end

    ------------------------
    -- INITIALIZATION
    ------------------------
    -- Always show auth UI first
    showAuthUI()
    
    -- Return the window
    return Window
end

-- Start the GUI
return StartExperienceGui()
