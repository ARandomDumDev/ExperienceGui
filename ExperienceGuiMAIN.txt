-- experienceguimain | Version 3.0.3 | CONVERTED TO MACLIB

local function StartExperienceGui()
    local HttpService = game:GetService("HttpService")
    local Players = game:GetService("Players")
    local LocalPlayer = Players.LocalPlayer

    -- Destroy leftover maintenance GUI
    for _, gui in ipairs(game.CoreGui:GetChildren()) do
        if gui.Name:find("ExperienceGui - Maintenance") then
            gui:Destroy()
        end
    end

    -- Load MacLib instead of Rayfield
    local MacLib = loadstring(game:HttpGet("https://github.com/biggaboy212/Maclib/releases/latest/download/maclib.txt"))()

    -- Create Window with MacLib (similar structure)
    local Window = MacLib:Window({
        Title = "ExperienceGui",
        Subtitle = "Made by CoolDown | MacLib",
        Size = UDim2.fromOffset(900, 680),
        DragStyle = 1,
        ShowUserInfo = true,
        Keybind = Enum.KeyCode.RightControl,
        AcrylicBlur = true
    })

    -- Set theme to match your original style
    Window.Settings.Theme = {
        Accent = Color3.fromRGB(85, 160, 255),
        Background = Color3.fromRGB(12, 15, 22),
        Secondary = Color3.fromRGB(18, 22, 32),
        Text = Color3.fromRGB(240, 240, 240),
        Muted = Color3.fromRGB(160, 160, 160),
    }

    Window:SetScale(1.07)
    Window:SetAcrylicBlurState(true)

    ------------------------
    -- KEY SYSTEM (Converted from Rayfield's KeySystem)
    ------------------------
    local VALID_KEYS = {"CoolDownExperience"}
    local keyPassed = false
    
    -- Create auth tab (blocking)
    local authTabGroup = Window:TabGroup()
    local authTab = authTabGroup:Tab({ 
        Name = "ðŸ”’ AUTHENTICATION", 
        Image = "rbxassetid://10734950309" 
    })
    local authSection = authTab:Section({ Side = "Left" })
    
    authSection:Header({ Name = "ExperienceGui Access" })
    authSection:Label({ Text = "Enter Password" })
    authSection:Label({ Text = "Password required to continue" })
    
    local keyInput = ""
    local keyInputElement = authSection:Input({
        Name = "Password",
        Placeholder = "Enter password here",
        Callback = function(input)
            keyInput = input
        end
    })
    
    authSection:Button({
        Name = "ðŸ”“ Authenticate",
        Callback = function()
            -- Check if key is valid
            local isValid = false
            for _, validKey in ipairs(VALID_KEYS) do
                if keyInput == validKey then
                    isValid = true
                    break
                end
            end
            
            if isValid then
                keyPassed = true
                Window:Notify({
                    Title = "âœ… Access Granted",
                    Description = "Welcome to ExperienceGui!",
                    Lifetime = 3
                })
                -- Remove auth tab and create main UI
                authTabGroup:Remove()
                createMainUI()
            else
                Window:Notify({
                    Title = "âŒ Invalid Password",
                    Description = "Please check your password and try again",
                    Lifetime = 3
                })
                keyInputElement:Set("")
                keyInput = ""
            end
        end
    })
    
    -- If auth fails, return early
    if not keyPassed then
        return Window
    end

    ------------------------
    -- MAIN UI CREATION FUNCTION (Only called after successful auth)
    ------------------------
    local function createMainUI()
        print("Creating main UI...")
        
        ------------------------
        -- CREATE TAB GROUPS
        ------------------------
        local MainTabGroup = Window:TabGroup()
        local ScriptTabGroup = Window:TabGroup()
        local NewsTabGroup = Window:TabGroup()
        
        -- Create tabs (using Image parameter instead of Icon)
        local HomeTab = MainTabGroup:Tab({ Name = "Home", Image = "rbxassetid://18821914323" })
        local NeedsTab = MainTabGroup:Tab({ Name = "Basic Needs", Image = "rbxassetid://10734950309" })
        local ScriptsTab = MainTabGroup:Tab({ Name = "Script Library", Image = "rbxassetid://10734950309" })
        local ExecTab = MainTabGroup:Tab({ Name = "Script Executor", Image = "rbxassetid://10734950309" })
        local ScriptBloxTab = MainTabGroup:Tab({ Name = "ScriptBlox", Image = "rbxassetid://10734950309" })
        local FavoritesTab = MainTabGroup:Tab({ Name = "Favorites", Image = "rbxassetid://10734950309" })
        local AnnTab = NewsTabGroup:Tab({ Name = "News", Image = "rbxassetid://10734950309" })
        
        ------------------------
        -- HOME TAB
        ------------------------
        local HomeSection = HomeTab:Section({ Side = "Left" })
        HomeSection:Header({ Name = "Welcome to ExperienceGui" })
        HomeSection:Label({ Text = "Made by CoolDown" })
        
        -- Get version from config (your original code)
        local version = "Unknown"
        local ok, result = pcall(function()
            return game:HttpGet("https://raw.githubusercontent.com/ARandomDumDev/ExperienceGui/refs/heads/main/config.json")
        end)
        if ok then
            local decodeOk, decoded = pcall(function()
                return HttpService:JSONDecode(result)
            end)
            if decodeOk and decoded.version then
                version = decoded.version
            end
        end
        
        HomeSection:Label({ Text = "Client: " .. LocalPlayer.Name })
        HomeSection:Label({ Text = "Version " .. version })
        
        ------------------------
        -- BASIC NEEDS TAB (Your original functionality)
        ------------------------
        local NeedsSection = NeedsTab:Section({ Side = "Left" })
        
        local walkSpeed = 16
        local jumpPower = 50
        
        NeedsSection:Slider({
            Name = "WalkSpeed",
            Default = 16,
            Minimum = 16,
            Maximum = 200,
            Precision = 0,
            Callback = function(Value)
                walkSpeed = Value
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChildWhichIsA("Humanoid") then
                    LocalPlayer.Character:FindFirstChildWhichIsA("Humanoid").WalkSpeed = Value
                end
            end
        })
        
        NeedsSection:Slider({
            Name = "JumpPower",
            Default = 50,
            Minimum = 50,
            Maximum = 300,
            Precision = 5,
            Callback = function(Value)
                jumpPower = Value
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChildWhichIsA("Humanoid") then
                    LocalPlayer.Character:FindFirstChildWhichIsA("Humanoid").JumpPower = Value
                end
            end
        })
        
        NeedsSection:Button({
            Name = "Enable Fly",
            Callback = function()
                loadstring(game:HttpGet("https://raw.githubusercontent.com/XNEOFF/FlyGuiV3/main/FlyGuiV3.txt"))()
            end
        })
        
        ------------------------
        -- SCRIPT EXECUTOR TAB (Your original functionality)
        ------------------------
        local ExecSection = ExecTab:Section({ Side = "Left" })
        ExecSection:Header({ Name = "Run Custom Code" })
        
        local codeString, urlString = "", ""
        
        local codeInputElement = ExecSection:Input({
            Name = "Lua Code",
            Placeholder = "Type Lua code here...",
            Callback = function(text)
                codeString = text
            end
        })
        
        local urlInputElement = ExecSection:Input({
            Name = "Script URL",
            Placeholder = "Type script URL here...",
            Callback = function(text)
                urlString = text
            end
        })
        
        ExecSection:Button({
            Name = "Execute",
            Callback = function()
                if codeString ~= "" then
                    local ok, err = pcall(function()
                        loadstring(codeString)()
                    end)
                    if not ok then 
                        warn("Failed to execute Lua code:", err)
                        Window:Notify({
                            Title = "Execution Error",
                            Description = tostring(err):sub(1, 100),
                            Lifetime = 5
                        })
                    else
                        Window:Notify({
                            Title = "âœ… Success",
                            Description = "Code executed successfully",
                            Lifetime = 3
                        })
                    end
                elseif urlString ~= "" then
                    local ok, err = pcall(function()
                        local scriptText = game:HttpGet(urlString)
                        loadstring(scriptText)()
                    end)
                    if not ok then 
                        warn("Failed to execute URL script:", err)
                        Window:Notify({
                            Title = "Download Error",
                            Description = tostring(err):sub(1, 100),
                            Lifetime = 5
                        })
                    else
                        Window:Notify({
                            Title = "âœ… Success",
                            Description = "Script loaded from URL",
                            Lifetime = 3
                        })
                    end
                end
                -- Clear input fields
                codeString = ""
                urlString = ""
                codeInputElement:Set("")
                urlInputElement:Set("")
            end
        })
        
        ------------------------
        -- SCRIPT LIBRARY (Your original functionality)
        ------------------------
        local ScriptsSection = ScriptsTab:Section({ Side = "Left" })
        
        local function LoadScriptLibrary()
            local success, result = pcall(function()
                return game:HttpGet("https://raw.githubusercontent.com/ARandomDumDev/ExperienceGui/refs/heads/main/Scripts.txt", true)
            end)
            if not success then
                ScriptsSection:Label({ Text = "âš ï¸ Failed to fetch Scripts.txt" })
                warn("HTTP GET failed:", result)
                return
            end

            local scripts
            local decodeSuccess, decodeResult = pcall(function()
                return HttpService:JSONDecode(result)
            end)
            if not decodeSuccess then
                ScriptsSection:Label({ Text = "âš ï¸ Failed to decode Scripts.txt" })
                warn("JSON Decode failed:", decodeResult)
                return
            end

            scripts = decodeResult
            if type(scripts) ~= "table" or #scripts == 0 then
                ScriptsSection:Label({ Text = "âš ï¸ No scripts found" })
                return
            end

            for _, scriptData in ipairs(scripts) do
                ScriptsSection:Button({
                    Name = scriptData.name or "Unnamed Script",
                    Callback = function()
                        if scriptData.url then
                            local ok, err = pcall(function()
                                loadstring(game:HttpGet(scriptData.url, true))()
                            end)
                            if not ok then 
                                warn("Failed to load script:", scriptData.name, err)
                                Window:Notify({
                                    Title = "Script Error",
                                    Description = "Failed to load: " .. (scriptData.name or "script"),
                                    Lifetime = 5
                                })
                            end
                        elseif scriptData.code then
                            local ok, err = pcall(function()
                                loadstring(scriptData.code)()
                            end)
                            if not ok then 
                                warn("Failed to execute script:", scriptData.name, err)
                                Window:Notify({
                                    Title = "Script Error",
                                    Description = "Failed to execute: " .. (scriptData.name or "script"),
                                    Lifetime = 5
                                })
                            end
                        else
                            warn("No url or code found for script:", scriptData.name)
                        end
                    end
                })
            end
        end
        
        -- Load script library after a delay
        task.spawn(function()
            task.wait(1)
            pcall(LoadScriptLibrary)
        end)
        
        ------------------------
        -- SCRIPTBLOX + FAVORITES (Your original functionality)
        ------------------------
        -- Saved favorites file and table
        local savedScripts = {}
        local savedFile = "ExperienceGui/SavedScripts.json"
        
        -- Helper: read saved file
        local function LoadSavedScriptsFromFile()
            if type(readfile) ~= "function" then
                return
            end
            local ok, content = pcall(function() return readfile(savedFile) end)
            if ok and content and content ~= "" then
                local sOk, data = pcall(function() return HttpService:JSONDecode(content) end)
                if sOk and type(data) == "table" then
                    savedScripts = data
                end
            end
        end
        
        -- Helper: write saved file
        local function SaveScriptsToFile()
            if type(writefile) ~= "function" then
                return
            end
            local ok, json = pcall(function() return HttpService:JSONEncode(savedScripts) end)
            if ok then
                pcall(function() writefile(savedFile, json) end)
            end
        end
        
        -- Refresh Favorites UI
        local function RefreshFavoritesUI()
            FavoritesTab:ClearSections()
            local FavSection = FavoritesTab:Section({ Side = "Left" })
            
            if #savedScripts == 0 then
                FavSection:Label({ Text = "âš ï¸ No favorites saved yet" })
                return
            end
            
            for i, s in ipairs(savedScripts) do
                local title = s.title or ("Saved Script " .. i)
                FavSection:Button({
                    Name = "â–¶ "..title,
                    Callback = function()
                        local ok, err = pcall(function()
                            if s.code and s.code ~= "" then
                                loadstring(s.code)()
                            elseif s.url and s.url ~= "" then
                                local scriptText = game:HttpGet(s.url, true)
                                loadstring(scriptText)()
                            else
                                warn("Favorite has neither code nor url:", title)
                            end
                        end)
                        if not ok then 
                            warn("Failed to run favorite:", title, err)
                            Window:Notify({
                                Title = "Favorite Error",
                                Description = "Failed to run: " .. title,
                                Lifetime = 5
                            })
                        end
                    end
                })
                FavSection:Button({
                    Name = "âœ– Remove: "..title,
                    Callback = function()
                        table.remove(savedScripts, i)
                        SaveScriptsToFile()
                        RefreshFavoritesUI()
                    end
                })
                FavSection:Divider()
            end
        end
        
        -- Save a favorite
        local function SaveFavorite(entry)
            entry = entry or {}
            -- simple duplicate check by url or title
            for _, e in ipairs(savedScripts) do
                if entry.url and e.url == entry.url then return end
                if entry.title and e.title == entry.title and (entry.code == e.code) then return end
            end
            table.insert(savedScripts, entry)
            SaveScriptsToFile()
            RefreshFavoritesUI()
        end
        
        -- Ping check
        local function MeasurePing(timeoutSeconds)
            timeoutSeconds = timeoutSeconds or 5
            local apiProbe = "https://scriptblox.com/api/script/search?limit=1&sort=trending"
            local startTime = os.clock()
            local ok, _ = pcall(function()
                local resp = game:HttpGet(apiProbe, true)
            end)
            local elapsed = os.clock() - startTime
            if not ok then
                return nil
            end
            return elapsed
        end
        
        -- URL encode
        local function UrlEncode(s)
            if type(s) ~= "string" then return "" end
            local ok, enc = pcall(function() return HttpService:UrlEncode(s) end)
            if ok and type(enc) == "string" then return enc end
            s = s:gsub("([^%w ])", function(c) return string.format("%%%02X", string.byte(c)) end)
            s = s:gsub(" ", "+")
            return s
        end
        
        -- Core: perform search on ScriptBlox
        local function SearchScriptBlox(query, limit)
            limit = limit or 20
            local q = query or ""
            local encoded = UrlEncode(q)
            local url
            if q == "" then
                url = string.format("https://scriptblox.com/api/script/fetch?max=%d", limit)
            else
                url = string.format("https://scriptblox.com/api/script/search?q=%s&max=%d", encoded, limit)
            end

            local ok, response = pcall(function() return game:HttpGet(url, true) end)
            if not ok then
                return nil, ("HTTP GET failed: %s"):format(tostring(response))
            end
            local decOk, data = pcall(function() return HttpService:JSONDecode(response) end)
            if not decOk then
                return nil, ("JSON decode failed: %s"):format(tostring(data))
            end
            if not data or not data.result or not data.result.scripts then
                return nil, "No scripts in response"
            end
            return data.result.scripts, nil
        end
        
        -- Render search results
        local function RenderScriptBloxResults(scripts)
            ScriptBloxTab:ClearSections()
            local SBSection = ScriptBloxTab:Section({ Side = "Left" })
            
            if not scripts or #scripts == 0 then
                SBSection:Label({ Text = "âš ï¸ No scripts found" })
                return
            end
            
            for _, info in ipairs(scripts) do
                local title = info.title or "Unnamed Script"
                local gameName = (info.game and info.game.name) or "Unknown Game"
                local display = ("[%s] %s"):format(gameName, title)

                -- Execute button
                SBSection:Button({
                    Name = "â–¶ "..display,
                    Callback = function()
                        local executed = false
                        if info.script and type(info.script) == "string" and info.script:match("%S") then
                            local ok, err = pcall(function() loadstring(info.script)() end)
                            if not ok then 
                                warn("Failed to execute inline script:", title, err)
                                Window:Notify({
                                    Title = "Script Error",
                                    Description = "Failed to execute: " .. title,
                                    Lifetime = 5
                                })
                            end
                            executed = true
                        elseif info.scriptUrl and type(info.scriptUrl) == "string" then
                            local ok, err = pcall(function()
                                local scriptText = game:HttpGet(info.scriptUrl, true)
                                loadstring(scriptText)()
                            end)
                            if not ok then 
                                warn("Failed to fetch/execute script at url:", (info.scriptUrl or "nil"), err)
                                Window:Notify({
                                    Title = "Script Error",
                                    Description = "Failed to load from URL",
                                    Lifetime = 5
                                })
                            end
                            executed = true
                        elseif info.script_id or info._id then
                            local id = info.script_id or info._id
                            local ok, detailResp = pcall(function()
                                return game:HttpGet(("https://scriptblox.com/api/script/%s"):format(tostring(id)), true)
                            end)
                            if ok then
                                local dec, det = pcall(function() return HttpService:JSONDecode(detailResp) end)
                                if dec and det and det.result and det.result.script and type(det.result.script) == "string" then
                                    pcall(function() loadstring(det.result.script)() end)
                                    executed = true
                                end
                            end
                        end
                        if not executed then
                            warn("Unable to execute script:", title)
                            Window:Notify({
                                Title = "Script Error",
                                Description = "Unable to execute: " .. title,
                                Lifetime = 5
                            })
                        end
                    end
                })

                -- Save button
                SBSection:Button({
                    Name = "ðŸ’¾ Save: "..display,
                    Callback = function()
                        local entry = {
                            title = title,
                            url = info.scriptUrl or info.url or info.link or nil,
                            code = (info.script and type(info.script) == "string") and info.script or nil,
                            id = info._id or info.script_id or nil,
                            game = (info.game and info.game.name) or nil
                        }
                        SaveFavorite(entry)
                        Window:Notify({
                            Title = "âœ… Saved",
                            Description = "Added to favorites: " .. title,
                            Lifetime = 3
                        })
                    end
                })
                
                SBSection:Divider()
            end
        end
        
        -- Create ScriptBlox UI
        local SBMainSection = ScriptBloxTab:Section({ Side = "Left" })
        SBMainSection:Header({ Name = "ScriptBlox Search" })
        
        local searchQuery = ""
        local liveSearchEnabled = false
        local pingThreshold = 0.35
        local lastSearchTick = 0
        local liveDebounce = 0.5
        
        local searchInputElement = SBMainSection:Input({
            Name = "Search Query",
            Placeholder = "Type keywords to search ScriptBlox...",
            Callback = function(text)
                searchQuery = text or ""
                local measureOk, ping = pcall(function() return MeasurePing() end)
                if measureOk and type(ping) == "number" and ping > 0 and ping <= pingThreshold then
                    liveSearchEnabled = true
                else
                    liveSearchEnabled = false
                end

                if liveSearchEnabled then
                    local now = tick()
                    if now - lastSearchTick < liveDebounce then
                        return
                    end
                    lastSearchTick = now
                    task.spawn(function()
                        local scripts, err = SearchScriptBlox(searchQuery, 15)
                        if not scripts then
                            ScriptBloxTab:ClearSections()
                            local ErrSection = ScriptBloxTab:Section({ Side = "Left" })
                            ErrSection:Label({ Text = "âš ï¸ Search failed: "..tostring(err) })
                            return
                        end
                        RenderScriptBloxResults(scripts)
                    end)
                end
            end
        })
        
        SBMainSection:Button({
            Name = "Search (manual)",
            Callback = function()
                local LoadingSection = ScriptBloxTab:Section({ Side = "Left" })
                LoadingSection:Label({ Text = "Searching ScriptBlox..." })
                task.spawn(function()
                    local scripts, err = SearchScriptBlox(searchQuery, 25)
                    if not scripts then
                        ScriptBloxTab:ClearSections()
                        local ErrSection = ScriptBloxTab:Section({ Side = "Left" })
                        ErrSection:Label({ Text = "âš ï¸ Search failed: "..tostring(err) })
                        return
                    end
                    RenderScriptBloxResults(scripts)
                end)
            end
        })
        
        SBMainSection:Button({
            Name = "Load Trending",
            Callback = function()
                local LoadingSection = ScriptBloxTab:Section({ Side = "Left" })
                LoadingSection:Label({ Text = "Loading trending scripts..." })
                task.spawn(function()
                    local scripts, err = SearchScriptBlox("", 25)
                    if not scripts then
                        ScriptBloxTab:ClearSections()
                        local ErrSection = ScriptBloxTab:Section({ Side = "Left" })
                        ErrSection:Label({ Text = "âš ï¸ Trending load failed: "..tostring(err) })
                        return
                    end
                    RenderScriptBloxResults(scripts)
                end)
            end
        })
        
        -- Initial load
        task.spawn(function()
            local ping = nil
            local ok, res = pcall(function() ping = MeasurePing() end)
            if ok and type(ping) == "number" and ping > 0 and ping <= pingThreshold then
                local scripts, err = SearchScriptBlox("", 20)
                if scripts then
                    RenderScriptBloxResults(scripts)
                else
                    SBMainSection:Label({ Text = "âš ï¸ Failed to load trending: "..tostring(err) })
                end
            else
                SBMainSection:Label({ Text = "Manual mode: press Search (manual) after typing query (slow ping or probe failed)." })
            end
        end)
        
        -- Load saved favorites
        LoadSavedScriptsFromFile()
        RefreshFavoritesUI()
        
        ------------------------
        -- NEWS TAB (Your original functionality)
        ------------------------
        local AnnSection = AnnTab:Section({ Side = "Left" })
        local announcementsUrl = "https://raw.githubusercontent.com/ARandomDumDev/ExperienceGui/refs/heads/main/announcementsChangelogs.json"
        
        local function LoadAnnouncements()
            AnnTab:ClearSections()
            local NewsSection = AnnTab:Section({ Side = "Left" })
            
            local success, result = pcall(function()
                return game:HttpGet(announcementsUrl, true)
            end)
            if not success then
                NewsSection:Label({ Text = "âš ï¸ Failed to fetch announcements" })
                warn("HTTP GET failed:", result)
                return
            end

            local data
            local decodeSuccess, decodeResult = pcall(function()
                return HttpService:JSONDecode(result)
            end)
            if not decodeSuccess then
                NewsSection:Label({ Text = "âš ï¸ Failed to decode announcements" })
                warn("JSON Decode failed:", decodeResult)
                return
            end

            data = decodeResult
            if data.announcement then
                NewsSection:Label({ Text = "ðŸ“¢ " .. data.announcement })
            else
                NewsSection:Label({ Text = "ðŸ“¢ No announcement at this time" })
            end

            if data.changelog then
                NewsSection:Label({ Text = "ðŸ“ " .. data.changelog })
            else
                NewsSection:Label({ Text = "ðŸ“ No changelog available" })
            end
        end
        
        -- Initial load and periodic refresh
        LoadAnnouncements()
        task.spawn(function()
            while true do
                task.wait(60)
                LoadAnnouncements()
            end
        end)
        
        ------------------------
        -- AUTORUN (Your original code)
        ------------------------
        task.spawn(function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/VapeVoidware/VW-Add/main/loader.lua", true))()
        end)
        
        ------------------------
        -- SELECT HOME TAB BY DEFAULT
        ------------------------
        HomeTab:Select()
        
        ------------------------
        -- WINDOW UNLOAD EVENT
        ------------------------
        Window.onUnloaded(function()
            print("ExperienceGui unloaded")
        end)
        
        Window:Notify({
            Title = "âœ… ExperienceGui",
            Description = "Successfully loaded with MacLib!",
            Lifetime = 3
        })
    end
    
    -- If auth was already passed (somehow), create main UI
    if keyPassed then
        createMainUI()
    end
    
    return Window
end

-- Call function and return for loader
return StartExperienceGui()
