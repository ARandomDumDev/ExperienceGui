-- ExperienceLoader 1.1
local configUrl = "https://raw.githubusercontent.com/ARandomDumDev/ExperienceGui/refs/heads/main/config.json"
local scriptUrl = "https://raw.githubusercontent.com/ARandomDumDev/ExperienceGui/refs/heads/main/ExperienceGuiMAIN.lua"

local HttpService = game:GetService("HttpService")
local currentGui
local currentVersion
local isMaintenance = false

local function loadGui()
    local ok, result = pcall(function()
        local source = game:HttpGet(scriptUrl)
        local fn = loadstring(source)
        -- GUI now returns a window object
        return fn()
    end)

    if ok then
        currentGui = result
    else
        warn("ExperienceLoader failed to load GUI:", result)
    end
end

local function unloadGui()
    if currentGui and currentGui.Destroy then
        currentGui:Destroy()
    end
    currentGui = nil
end

local function showMaintenance(message)
    unloadGui()
    local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()
    local win = Rayfield:CreateWindow({
        Name = "ExperienceGui - Maintenance",
        LoadingTitle = "Maintenance",
        LoadingSubtitle = "Please wait...",
    })
    win:CreateTab("Notice", 4483362458):CreateLabel(message or "Down for maintenance.")
    currentGui = {
        Destroy = function()
            win:Destroy()
        end
    }
end

-- Poll config.json
task.spawn(function()
    while task.wait(10) do
        local ok, result = pcall(function()
            return game:HttpGet(configUrl)
        end)

        if ok then
            local decodeOk, cfg = pcall(function()
                return HttpService:JSONDecode(result)
            end)

            if not decodeOk or type(cfg) ~= "table" then
                warn("ExperienceLoader failed to decode config.json")
                continue
            end

            if cfg.maintenance then
                if not isMaintenance then
                    showMaintenance(cfg.message)
                    isMaintenance = true
                end
            else
                if isMaintenance or not currentGui then
                    unloadGui()
                    loadGui()
                    currentVersion = cfg.version
                    isMaintenance = false
                elseif cfg.version and cfg.version ~= currentVersion then
                    unloadGui()
                    loadGui()
                    currentVersion = cfg.version
                end
            end
        end
    end
end)

-- Initial boot load (without waiting for the first poll interval)
loadGui()
