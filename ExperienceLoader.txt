local HttpService = game:GetService("HttpService")

-- Cache Rayfield once
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

-- URLs
local configUrl = "https://raw.githubusercontent.com/ARandomDumDev/ExperienceGui/refs/heads/main/config.json"
local scriptUrl = "https://raw.githubusercontent.com/ARandomDumDev/ExperienceGui/refs/heads/main/ExperienceGuiMAIN.txt"

-- ðŸ”¹ Preloader GUI
local preloaderWin = Rayfield:CreateWindow({
    Name = "ExperienceGui - Loading",
    LoadingTitle = "Loadingâ€¦",
    LoadingSubtitle = "Please donâ€™t spam, I know you will spam",
})
local preloaderTab = preloaderWin:CreateTab("Status", 4483362458)
local preloaderLabel = preloaderTab:CreateLabel("Fetching config.json...")

-- ðŸ”¹ Maintenance GUI (hidden by default)
local maintenanceWin = Rayfield:CreateWindow({
    Name = "ExperienceGui - Maintenance",
    LoadingTitle = "Maintenance",
    LoadingSubtitle = "Please wait...",
})
local maintenanceTab = maintenanceWin:CreateTab("Notice", 4483362458)
local maintenanceLabel = maintenanceTab:CreateLabel("Checking status...")

maintenanceWin:SetVisibility(false)

-- Holder for main GUI
local currentGui
local currentVersion

-- Load main GUI
local function loadGui()
    local source = game:HttpGet(scriptUrl)
    local fn = loadstring(source)
    currentGui = fn()
end

-- Unload main GUI
local function unloadGui()
    if currentGui and currentGui.Destroy then
        currentGui:Destroy()
    end
    currentGui = nil
end

-- ðŸ”¹ Poll config.json
task.spawn(function()
    while task.wait(10) do
        local ok, result = pcall(function()
            return game:HttpGet(configUrl)
        end)

        if ok then
            local cfg = HttpService:JSONDecode(result)

            -- Hide preloader after first successful config fetch
            if preloaderWin then
                preloaderWin:SetVisibility(false)
                preloaderWin = nil
            end

            if cfg.maintenance then
                unloadGui()
                maintenanceLabel:Set(cfg.message or "Down for maintenance.")
                maintenanceWin:SetVisibility(true)
            else
                maintenanceWin:SetVisibility(false)

                if (not currentGui) or (cfg.version and cfg.version ~= currentVersion) then
                    unloadGui()
                    loadGui()
                    currentVersion = cfg.version
                end
            end
        else
            if preloaderLabel then
                preloaderLabel:Set("Failed to fetch config, retrying...")
            end
        end
    end
end)
